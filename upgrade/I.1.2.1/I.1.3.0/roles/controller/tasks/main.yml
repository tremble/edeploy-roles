---
# file: roles/controller/tasks/main.yml

# RabbitMQ is upgraded in RHEL7
- name: stop rabbitmq
  service: name=rabbitmq-server state=stopped
  tags: before_config
  when: ansible_distribution == 'RedHat'

# MySQL is upgraded in RHEL7
# since we don't know if the node is master or not, we stop mysql anyway
- name: stop mysql
  service: name=mariadb state=stopped
  tags: before_config
  ignore_errors: yes
  register: mysql_shutdown
  when: ansible_distribution == 'RedHat'

- name: stop mysql-bootstrap
  service: name=mysql-bootstrap state=stopped
  tags: before_config
  ignore_errors: yes
  register: mysqlbootstrap_shutdown
  when: ansible_distribution == 'RedHat'

- name: edeploy upgrade
  edeploy: command=upgrade version={{ distro }}-{{ version }}
  tags: before_config

- name: start rabbitmq
  service: name=rabbitmq-server state=started
  tags: before_config
  when: ansible_distribution == 'RedHat' and inventory_hostname == groups['controller'][-1]


# If MySQL was running before the upgrade, then we need to start it back up
- name: restart mysql
  service: name=mariadb state=restarted
  tags: before_config
  when: ansible_distribution == 'RedHat' and mysql_shutdown.changed

- name: create systemd mysql-bootstrap script
  copy: src=mysql-bootstrap.service dest=/usr/lib/systemd/system/mysql-bootstrap.service
  tags: before_config
  when: ansible_distribution == 'RedHat' and mysqlbootstrap_shutdown.changed

- name: reload systemd scripts list
  command: systemctl daemon-reload
  tags: before_config
  when: ansible_distribution == 'RedHat' and mysqlbootstrap_shutdown.changed

- name: restart mysql-bootstrap
  service: name=mysql-bootstrap state=restarted
  tags: before_config
  when: ansible_distribution == 'RedHat' and mysqlbootstrap_shutdown.changed

# after upgrade, heat-api is zombie
- name: kill heat-api process
  command: pkill -9 heat-api
  tags: before_config
  when: ansible_distribution == 'Debian'

# then, restart it
- name: start heat-api service
  service: name=heat-api state=started
  tags: before_config
  when: ansible_distribution == 'Debian'

# sensu has been upgrade in Debian
# from 0.14.0-1 to 0.16.0-1
- name: restart sensu
  service: name=sensu-client state=restarted
  tags: before_config
  when: ansible_distribution == 'Debian'

- name: restart Cinder services after upgrade
  service: name={{ item }} state=restarted
  with_items:
    - openstack-cinder-api
    - openstack-cinder-volume
  tags: after_config
  when: ansible_distribution == 'RedHat'

- name: restart apache after upgrade
  service: name=httpd state=restarted
  tags: after_config
  when: ansible_distribution == 'RedHat'
